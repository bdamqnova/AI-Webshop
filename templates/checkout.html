<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Checkout - CyberBear</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://js.stripe.com/v3/"></script>
<style>
body { font-family: "Inter", sans-serif; background:#121212; color:#fff; margin:0; padding:30px; }
.container { max-width: 900px; margin: 30px auto; padding: 20px; }
h1 { text-align:center; margin-bottom: 20px; text-shadow: 0 0 8px #1b73d8; }

.cart-table, .payment-table { width: 100%; border-collapse: collapse; margin-bottom:20px; }
.cart-table th, .cart-table td,
.payment-table th, .payment-table td { padding: 12px; border-bottom: 1px solid #2a2a2a; text-align:left; }
.cart-table th, .payment-table th { color:#1b73d8; }

#paymentForm { display: none; background:#1d1d1d; padding:20px; border-radius:10px; margin-top:20px; border:1px solid #2b2b2b; }
label { display:block; margin-top:15px; font-weight:600; }
input { width:100%; padding:10px; border-radius:6px; border:1px solid #333; background:#161616; color:white; margin-top:6px; }

#card-element { padding:12px; border-radius:6px; border:1px solid #333; background:#161616; margin-top:6px; }
#card-errors { color:#ff4b4b; margin-top:10px; font-size:14px; }

.checkout-btn, .pay-btn { background:#1b73d8; color:#fff; border:none; padding:12px 20px; border-radius:6px; cursor:pointer; font-size:16px; margin-top:20px; transition:0.3s; width:100%; }
.checkout-btn:hover, .pay-btn:hover { background:#00b7ff; transform:translateY(-2px); }
</style>
</head>
<body>

<div class="container">
  <h1>Checkout</h1>

  <table class="cart-table" id="cartTable">
    <thead>
      <tr><th>Product</th><th>Price</th><th>Qty</th><th>Total</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="cart-total">Total: $<span id="cartTotal">0</span></div>
  <button class="checkout-btn" id="checkoutBtn">Checkout</button>

  <!-- Payment Form -->
  <div id="paymentForm">
    <h2>Enter Payment Details</h2>
    <form id="stripeForm">
      <label>Full Name</label>
      <input type="text" id="name" required>

      <label>Email</label>
      <input type="email" id="email" required>

      <label>Card Details</label>
      <div id="card-element"></div>
      <div id="card-errors" role="alert"></div>

      <button class="pay-btn" type="submit">Pay $<span id="payAmount">0</span></button>
    </form>
  </div>
</div>

<script>
const stripe = Stripe("{{ pub_key }}"); // your public key
const elements = stripe.elements();
const card = elements.create("card", {style:{base:{color:"#fff",fontFamily:"Inter, sans-serif",fontSize:"16px","::placeholder":{color:"#777"}}}});
card.mount("#card-element");

let cart = JSON.parse(localStorage.getItem('cart')) || [];

function renderCart() {
    const tbody = document.querySelector("#cartTable tbody");
    tbody.innerHTML = "";
    let total = 0;
    cart.forEach(item => {
        const tr = document.createElement("tr");
        const itemTotal = item.price * item.quantity;
        tr.innerHTML = `<td>${item.name}</td><td>$${item.price.toFixed(2)}</td><td>${item.quantity}</td><td>$${itemTotal.toFixed(2)}</td>`;
        tbody.appendChild(tr);
        total += itemTotal;
    });
    document.getElementById("cartTotal").textContent = total.toFixed(2);
    document.getElementById("payAmount").textContent = total.toFixed(2);
}

renderCart();

// Show payment form
document.getElementById("checkoutBtn").addEventListener("click", () => {
    if(cart.length === 0){ alert("Your cart is empty!"); return; }
    document.getElementById("paymentForm").style.display = "block";
    window.scrollTo(0, document.getElementById("paymentForm").offsetTop);
});

// Handle Stripe payment
document.getElementById("stripeForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const {token, error} = await stripe.createToken(card, {name: document.getElementById("name").value});

    if(error){
        document.getElementById("card-errors").textContent = error.message;
        return;
    }

    // Send token and cart total to backend
    const totalAmount = cart.reduce((sum, i)=> sum + i.price * i.quantity, 0);
    const response = await fetch("/process_payment", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({
            token: token.id,
            email: document.getElementById("email").value,
            amount: totalAmount
        })
    });

    const result = await response.json();
    if(result.success){
        alert("Payment successful!");
        localStorage.removeItem("cart");
        window.location.href = "/payment_success";
    } else {
        document.getElementById("card-errors").textContent = result.error;
    }
});
</script>

</body>
</html>
